import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { createPageUrl } from '../utils';
import { base44 } from '@/api/base44Client';
import { motion } from 'framer-motion';
import { 
  BarChart3, 
  Users, 
  GraduationCap, 
  School,
  ArrowLeft,
  Loader2,
  RefreshCw,
  AlertCircle
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { AudienceChart, ReformChart, LearningModeChart, ContentAreasChart } from '../components/dashboard/AnalysisCharts';
import PedagogicalPulse from '../components/dashboard/PedagogicalPulse';
import AdvancedInsights from '../components/dashboard/AdvancedInsights';

export default function Dashboard() {
  const navigate = useNavigate();
  const [pesga, setPesga] = useState(null);
  const [loading, setLoading] = useState(true);
  const [analyzing, setAnalyzing] = useState(false);
  const [analysisData, setAnalysisData] = useState(null);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    const pesgas = await base44.entities.Pesga.list('-created_date', 1);
    if (pesgas.length > 0) {
      setPesga(pesgas[0]);
      if (pesgas[0].analysis_data) {
        setAnalysisData(pesgas[0].analysis_data);
      } else if (pesgas[0].training_file_url) {
        await analyzeData(pesgas[0]);
      } else {
        // Generate sample data if no file uploaded
        generateSampleData();
      }
    }
    setLoading(false);
  };

  const generateSampleData = () => {
    const sampleData = {
      audienceData: [
        { name: 'גנים', value: 25 },
        { name: 'יסודי', value: 35 },
        { name: 'תיכון', value: 30 },
        { name: 'חנ"מ', value: 10 }
      ],
      reformData: [
        { name: 'אופק חדש', value: 65 },
        { name: 'עוז לתמורה', value: 35 }
      ],
      learningModeData: [
        { name: 'פרונטלי', value: 40 },
        { name: 'סינכרוני', value: 35 },
        { name: 'אסינכרוני', value: 25 }
      ],
      contentAreasData: [
        { name: 'מנהיגות', value: 30 },
        { name: 'טכנו-פדגוגיה', value: 45 },
        { name: 'חינוך מיוחד', value: 25 }
      ],
      totalTrainings: 87,
      totalParticipants: 1250,
      avgSatisfaction: 4.2
    };
    setAnalysisData(sampleData);
  };

  const analyzeData = async (pesgaData) => {
    setAnalyzing(true);
    
    const result = await base44.integrations.Core.ExtractDataFromUploadedFile({
      file_url: pesgaData.training_file_url,
      json_schema: {
        type: "object",
        properties: {
          trainings: {
            type: "array",
            items: {
              type: "object",
              properties: {
                name: { type: "string" },
                audience: { type: "string" },
                reform: { type: "string" },
                learning_mode: { type: "string" },
                content_area: { type: "string" },
                participants: { type: "number" }
              }
            }
          }
        }
      }
    });

    let processedData;
    
    if (result.status === "success" && result.output?.trainings) {
      const trainings = result.output.trainings;
      
      // Process the data
      const audienceCounts = {};
      const reformCounts = {};
      const modeCounts = {};
      const areaCounts = {};
      let totalParticipants = 0;

      trainings.forEach(t => {
        audienceCounts[t.audience] = (audienceCounts[t.audience] || 0) + 1;
        reformCounts[t.reform] = (reformCounts[t.reform] || 0) + 1;
        modeCounts[t.learning_mode] = (modeCounts[t.learning_mode] || 0) + 1;
        areaCounts[t.content_area] = (areaCounts[t.content_area] || 0) + 1;
        totalParticipants += t.participants || 0;
      });

      processedData = {
        audienceData: Object.entries(audienceCounts).map(([name, value]) => ({ name, value })),
        reformData: Object.entries(reformCounts).map(([name, value]) => ({ name, value })),
        learningModeData: Object.entries(modeCounts).map(([name, value]) => ({ name, value })),
        contentAreasData: Object.entries(areaCounts).map(([name, value]) => ({ name, value })),
        totalTrainings: trainings.length,
        totalParticipants,
        avgSatisfaction: 4.2
      };
    } else {
      // Fallback to sample data
      generateSampleData();
      setAnalyzing(false);
      return;
    }

    setAnalysisData(processedData);
    
    // Save to database
    await base44.entities.Pesga.update(pesgaData.id, {
      analysis_data: processedData,
      status: 'reflection'
    });
    
    setAnalyzing(false);
  };

  const handleContinue = async () => {
    if (pesga) {
      await base44.entities.Pesga.update(pesga.id, { status: 'reflection' });
    }
    navigate(createPageUrl('Reflection'));
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <Loader2 className="w-8 h-8 animate-spin text-[#1E3A5F]" />
      </div>
    );
  }

  if (!pesga) {
    return (
      <div className="text-center py-16">
        <AlertCircle className="w-16 h-16 mx-auto text-[#8B1A1A] mb-4" />
        <h2 className="text-xl font-bold text-[#1E3A5F] mb-2">לא נמצאו נתונים</h2>
        <p className="text-[#1E3A5F]/60 mb-6">יש להשלים תחילה את שלב קליטת הנתונים</p>
        <Button onClick={() => navigate(createPageUrl('Onboarding'))}>
          חזרה לקליטת נתונים
        </Button>
      </div>
    );
  }

  return (
    <div className="space-y-8">
      {/* Header */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="text-center"
      >
        <div className="inline-flex items-center gap-2 bg-white border-2 border-emerald-500 text-emerald-700 px-4 py-2 rounded-full text-sm font-medium mb-4">
          <span className="w-6 h-6 bg-white border-2 border-emerald-500 text-emerald-700 rounded-full flex items-center justify-center text-xs font-bold">2</span>
          שלב שני
        </div>
        <h1 className="text-3xl font-bold text-[#1E3A5F] mb-3">
          ניתוח פדגוגי - {pesga?.city || 'טוען...'}
        </h1>
        <p className="text-[#1E3A5F]/60 max-w-xl mx-auto">
          {pesga?.personal_name && `${pesga.personal_name}, `}דשבורד ויזואלי המציג ניתוח מעמיק של נתוני ההשתלמויות שלכם
        </p>
      </motion.div>

      {/* Stats Cards */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        className="grid grid-cols-2 md:grid-cols-4 gap-4"
      >
        <Card className="border-0 shadow-lg bg-gradient-to-br from-[#1E3A5F] to-[#2d4a6f] text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <BarChart3 className="w-8 h-8 text-white/80" />
            </div>
            <p className="text-3xl font-bold">{analysisData?.totalTrainings || 0}</p>
            <p className="text-white/70 text-sm">השתלמויות</p>
          </CardContent>
        </Card>

        <Card className="border-0 shadow-lg bg-gradient-to-br from-[#D4AF37] to-[#c4a030] text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <Users className="w-8 h-8 text-white/80" />
            </div>
            <p className="text-3xl font-bold">{analysisData?.totalParticipants?.toLocaleString() || 0}</p>
            <p className="text-white/70 text-sm">משתתפים</p>
          </CardContent>
        </Card>

        <Card className="border-0 shadow-lg bg-gradient-to-br from-emerald-500 to-emerald-600 text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <School className="w-8 h-8 text-white/80" />
            </div>
            <p className="text-3xl font-bold">{pesga.kindergartens_count + pesga.elementary_count + pesga.high_school_count}</p>
            <p className="text-white/70 text-sm">מוסדות חינוך</p>
          </CardContent>
        </Card>

        <Card className="border-0 shadow-lg bg-gradient-to-br from-purple-500 to-purple-600 text-white">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-4">
              <GraduationCap className="w-8 h-8 text-white/80" />
            </div>
            <p className="text-3xl font-bold">{analysisData?.avgSatisfaction || '—'}</p>
            <p className="text-white/70 text-sm">שביעות רצון ממוצעת</p>
          </CardContent>
        </Card>
      </motion.div>

      {/* Pedagogical Pulse - Only show after reflection is complete */}
      {pesga?.reflective_answers?.length > 0 && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.15 }}
        >
          <PedagogicalPulse pesga={pesga} />
        </motion.div>
      )}

      {/* Charts */}
      {analyzing ? (
        <div className="text-center py-16">
          <Loader2 className="w-12 h-12 mx-auto animate-spin text-[#D4AF37] mb-4" />
          <p className="text-[#1E3A5F] font-medium">מנתח את נתוני ההשתלמויות...</p>
          <p className="text-[#1E3A5F]/60 text-sm">זה עשוי לקחת מספר שניות</p>
        </div>
      ) : analysisData ? (
        <>
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="grid md:grid-cols-2 gap-6"
          >
            <AudienceChart data={analysisData.audienceData} />
            <ReformChart data={analysisData.reformData} />
            <LearningModeChart data={analysisData.learningModeData} />
            <ContentAreasChart data={analysisData.contentAreasData} />
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.3 }}
          >
            <AdvancedInsights pesga={pesga} analysisData={analysisData} />
          </motion.div>
        </>
        ) : null}

      {/* Continue Button */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.4 }}
        className="flex justify-center pt-4"
      >
        <Button
          onClick={handleContinue}
          size="lg"
          className="bg-[#1E3A5F] hover:bg-[#2d4a6f] text-white px-8 gap-2"
        >
          המשך לשיחה הרפלקטיבית
          <ArrowLeft className="w-4 h-4" />
        </Button>
      </motion.div>
    </div>
  );
}
